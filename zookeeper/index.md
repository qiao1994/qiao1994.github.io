# Zookeeper


ZooKeeper是一个分布式协调服务 ，通过 ZAB 算法实现数据一致性，并为各种大数据系统提供主服务器选举服务。虽然 ZooKeeper 并没有什么特别强大的功能，但是在各类分布式系统和大数据系统中，ZooKeeper 的出镜率非常高，因此也是很多系统的基础设施。

# ZooKeeper 集群架构与读写机制

在 ZooKeeper 集群中，服务器角色分为领导者（leader）和学习者（learner），后者又分为观察者（observer）和跟随者（follower），具体功能如下：

* 领导者：为客户端提供读写功能，负责投票的发起和决议。集群中只有领导者才能接受写服务。
* 跟随者：为客户端提供读服务，如果是写服务则转发给领导者。跟随者在选举过程中进行投票。
* 观察者：为客户端提供读服务，如果是写服务就转发给领导者。观察者不参与领导者的选举投票，也不参与写的过半原则机制。

# Zookeeper 特点

* 一致性：客户端无论连接到集群中的哪个节点，读到的数据都是一样的。
* 实时性：ZooKeeper 保证客户端在一定的时间间隔内获得结果，包括成功和失败。但由于网络延迟原因，ZooKeeper 不能保证两台客户端同时得到刚更新的消息。如果都需要最新的消息，就需要调用 sync() 接口。
* 原子性：领导者在同步数据时会保证事务性，要么都成功，要么都失败。
* 顺序性：一台服务器上如果消息 a 在消息 b 前发布，那么所有服务器上的消息 a 都是在消息 b 前发布的。

# Zookeeper 如何保证数据一致性

ZooKeeper 通过 ZAB 协议来进行 ZooKeeper 集群间的数据同步，保证数据的一致性。

写数据的步骤：

* 写请求到达某节点（如果该节点不是领导节点，那么请求会转发给领导节点）
* 写请求到达领导节点
* 领导者节点将数据通过 Proposal 请求发送给所有节点（包括自己）
* 所有节点接收数据后都会写到本地磁盘上，并发送 ACK 请求给领导者
* 领导者只要接收到过半节点的请求，就会执行commit并发送 commit 消息给各个节点
* 各个节点再把消息放入内存（以保证高性能），该消息就会用户可见了

这时，如果 ZooKeeper 想保证数据一致性，就需要考虑如下两种情况。

* 情况一：领导者执行了 commit，还没来得及给跟随者发送 commit 时，领导者宕机了，那该如何保证消息一致性？

  > 当领导者宕机后，ZooKeeper 会选举出新的领导者节点，新的领导者节点启动后，会到磁盘上检查是否存在没有进行 commit 的消息，如果存在，就继续检查其他跟随者有没有对这条消息进行 commit，如果有过半节点对这条消息进行了 ACK，但没有 commit，那么新的领导者就要完成 commit 的操作。

* 情况二：客户端把消息写到领导者节点了，但领导者还没发送 Proposal 消息给其他节点就宕机了。在领导者恢复期间，此消息又该如何处理？

  > 客户端将消息写到领导者节点了，但领导者还没发送 Proposal 消息就宕机了。这时对于用户来说，这条消息是写失败的。假设一段时间后，领导者节点恢复了，而这时它的角色就变成了跟随者。它在检查自己磁盘时会发现自己有一条消息没有进行 commit，这时，它会检测消息的编号。因为每条消息都有编号，由高 32 位和低 32 位组成，高 32 位是用来体现是否发生过领导者切换的，低 32 位用来展示消息顺序。当上述跟随者检测消息编号时，它会根据高 32 位知道目前领导者已经切换过了，所以就把当前的消息删除，然后与新领导者同步数据，这样就保证了数据的一致性。
