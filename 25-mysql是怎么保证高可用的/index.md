# 25.MySQL是怎么保证高可用的


## 主备延迟

* 主库A执行完成一个事务，写入binlog，我们把这个时刻记为T1;
* 之后传给备库B，我们把备库B接收完这个binlog的时刻记为T2;
* 备库B执行完成这个事务，我们把这个时刻记为T3。

T3-T1即为主备延迟

## 主备延迟的来源

* 备库所在机器性能差
* 备库用得比较随意
* 大事务
* 大表DDL

## 主备切换策略

### 可靠性优先

* 判断备库B现在的seconds_behind_master，如果小于某个值（比如5秒）继续下一步，否则持续重试这一步；
* 把主库A改成只读状态，即把readonly设置为true；
* 判断备库B的seconds_behind_master的值，直到这个值变成0为止；
* 把备库B改成可读写状态，也就是把readonly 设置为false；
* 把业务请求切到备库B。

问题是会有一段时间服务不可用。

### 可用性优先

* 强行把步骤4、5调整到最开始执行，也就是说不等主备数据同步，直接把连接切到备库B，并且让备库B可以读写，那么系统几乎就没有不可用时间了。

问题是可能会出现数据不一致等问题。
