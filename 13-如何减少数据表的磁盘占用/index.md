# 13.如何减少MySQL表的磁盘占用


## 参数innodb_file_per_table

* OFF：表的数据放在系统共享表空间，也就是跟数据字典放在一起
* ON：每个InnoDB表数据存储在一个以 .ibd为后缀的文件中

> ON是推荐做法

## 数据删除流程

* 删除一行数据时，innodb只会把数据在索引树中的位置标记为删除；如果之后再插入新的数据，且符合该位置的索引顺序关系，即可直接复用这个位置。
* 如果一个数据页上的所有数据都删除了，那么整个数据页就都可以复用了；但是整页复用不需要符合索引范围，可以复用到任何位置
* 如果相邻的两个数据页的利用率都很低，系统就会合并他们
* 如果整个表的数据都被删除，那就是所有的数据页都可以复用了，磁盘文件不会变小。

> 删除数据不会减小磁盘占用，只会产生数据空洞
>
> 插入、修改表数据都会造成空洞

## 重建表才能删除空洞

* 原表A，创建一个临时表B，把A中的数据迁移到临时表B，用临时表B替换A
* 命令alter table A engine=InnoDB可以重建表
* Online DDL
* 重建表的过程中，不能接受有新数据插入表A
* 一个可选的解决方案是在迁移过程中，对A的操作都记录下，迁移完成后再运行给临时表B；这样就做到了对表A无影响。

* Online和inplace

  * online是指对业务无影响
  * inplace是指在innodb层完成，对server层透明
