# 12.MySQL抖动


## 刷脏页

和磁盘不一致的内存页成为脏页，大多数更新操作MySQL都是修改内存和写入redo log，但是在某些情况下，需要把脏页写入磁盘，称之为"刷脏页"

## 啥时候需要"刷脏页''

* redo log 满了，需要把redo log写入磁盘

  >整个系统就不能再接受更新了，所有的更新都必须阻塞

* 系统内存不足，需要淘汰一些数据页，空出内存给别的数据页使用【常态】；这种情况下旧内存有三种情况

  * 还没有使用的：直接释放即可
  * 使用了并且是干净页：直接释放即可
  * 使用了并且是脏页 【常态】；这种情况需要把脏页刷入磁盘，再继续操作，如果出现下面两种情况，会明显影响性能
    * 一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长；
    * 日志写满，更新全部堵住，写性能跌为0(同情况1)

* MySQL认为系统空闲，刷脏页

  > 不影响性能

* MySQL正常关闭

  > 不影响性能

## innodb刷脏页的控制策略

InnoDB的刷盘速度就是要参考这两个因素：一个是脏页比例innodb_io_capacity，一个是redo log写盘速度。

### carry 邻居策略

在准备刷一个脏页的时候，如果这个数据页旁边的数据页刚好是脏页，就会把这个“邻居”也带着一起刷掉；而且这个把“邻居”拖下水的逻辑还可以继续蔓延，也就是对于每个邻居数据页，如果跟它相邻的数据页也还是脏页的话，也会被放到一起刷。

这个策略在机械硬盘时代，是很有意义的，可以减少很多随机IO，但是SSD下就意义不大了，可以通过innodb_flush_neighbors关闭它。
